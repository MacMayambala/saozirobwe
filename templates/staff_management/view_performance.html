{% extends 'base.html' %}
{% load static date_tags %}

{% block title %}
    {% if staff %}
        Performance Overview - {{ staff.first_name }} {{ staff.last_name }} | Sao Zirobwe SACCO
    {% else %}
        Performance Overview | Sao Zirobwe SACCO
    {% endif %}
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header Section -->
    <div class="header-section d-flex justify-content-between align-items-center mb-4">
        <h1 class="text-custom-primary fw-bold mb-0">
            <i class="bi bi-person-fill me-2"></i>
            {% if staff %}
                Performance Overview: {{ staff.first_name }} {{ staff.last_name }}
            {% else %}
                Performance Overview: Staff Not Found
            {% endif %}
        </h1>
        <div class="d-flex gap-3">
            <a href="{% url 'staff_management:add_branch' %}" class="btn-custom-primary btn-sm" aria-label="Add New Branch">
                <i class="bi bi-building-add me-1"></i>Add Branch
            </a>
            <a href="{% url 'staff_management:staff_dashboard' %}" class="btn btn-outline-secondary btn-sm" aria-label="Return to Staff Dashboard">
                <i class="bi bi-arrow-left me-1"></i>Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Notification Alerts -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-dismissible fade show mb-4 {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' %}alert-danger{% else %}alert-info{% endif %}" role="alert">
                <span class="fw-medium">{{ message }}</span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Staff Profile Card -->
    {% if staff %}
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header d-flex justify-content-end p-3">
                <div class="dropdown">
                    <button class="btn-custom-primary btn-sm dropdown-toggle" type="button" id="menuDropdown" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Staff Actions">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="menuDropdown">
                        <li><a class="dropdown-item" href="{% url 'staff_management:view_performance' staff_id=staff.id %}">View Performance</a></li>
                        <li><a class="dropdown-item" href="{% url 'staff_management:leave_management' staff_id=staff.id %}">Leave Management</a></li>
                    </ul>
                </div>
            </div>
            <div class="card-body p-4">
                <div class="d-flex align-items-center">
                    <div class="profile-image me-3">
                        {% if staff.profile_photo %}
                            <img src="{{ staff.profile_photo.url }}" alt="Profile photo of {{ staff.first_name }} {{ staff.last_name }}" class="rounded-circle border border-2 border-custom-primary" style="width: 80px; height: 80px; object-fit: cover;">
                        {% else %}
                            <i class="bi bi-person-circle text-muted" style="font-size: 80px;"></i>
                        {% endif %}
                    </div>
                    <div class="staff-details">
                        <p class="mb-1"><span class="text-secondary fw-bold">Name:</span> {{ staff.first_name }} {{ staff.last_name }}</p>
                        <p class="mb-1"><span class="text-secondary fw-bold">Email:</span> {{ staff.email|default:"Not provided" }}</p>
                        <p class="mb-1"><span class="text-secondary fw-bold">Phone:</span> +{{ staff.phone|default:"Not provided" }}</p>
                        <p class="mb-1"><span class="text-secondary fw-bold">Position:</span> {{ staff.position.name|default:"Not assigned" }}</p>
                        <p class="mb-1"><span class="text-secondary fw-bold">Department:</span> {{ staff.department.name|default:"Not assigned" }}</p>
                        {% if has_approved_leave and latest_approved_leave %}
                            <p class="mb-0"><span class="text-secondary fw-bold">Leave Status:</span> On Leave ({{ latest_approved_leave.remaining_days }} days remaining)</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Targets Table -->
        <div class="card shadow-sm">
            <div class="card-body">
                <h3 class="mb-3">Current Targets</h3>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Target Type</th>
                                <th>Goal</th>
                                <th>Description</th>
                                <th>Current</th>
                                <th>Progress</th>
                                <th>End Date</th>
                                <th>Period</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for target in targets %}
                                <tr>
                                    <td>{{ target.target_type.stname|default:"N/A" }}</td>
                                    <td>{{ target.goal_value|floatformat:2 }}</td>
                                    <td>{{ target.target_type.description|default:"No description" }}</td>
                                    <td>{{ target.current_value|floatformat:2 }}</td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-success" role="progressbar" style="width: {{ target.completion_percentage|floatformat:1 }}%;" aria-valuenow="{{ target.completion_percentage|floatformat:1 }}" aria-valuemin="0" aria-valuemax="100">
                                                {{ target.completion_percentage|floatformat:1 }}%
                                            </div>
                                        </div>
                                    </td>
                                    <td class="{% if target.end_date|is_future_date %}text-active{% else %}text-ended{% endif %}">
                                        {{ target.end_date|date:"d/m/Y"|default:"N/A" }}
                                    </td>
                                    <td>{{ target.period|default:"N/A" }}</td>
                                    <td>
                                        <div class="d-flex gap-2 flex-wrap">
                                            <button type="button" class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#editGoalModal{{ target.id }}" aria-label="Edit target {{ target.target_type.stname|default:'target' }}" title="Edit target details">
                                                <i class="bi bi-pencil me-1"></i>Edit Target
                                            </button>
                                            <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#updateModal{{ target.id }}" aria-label="Record transaction for {{ target.target_type.stname|default:'target' }}" title="Record a new transaction">
                                                <i class="bi bi-arrow-up-circle me-1"></i>Record Transaction
                                            </button>
                                            <form action="{% url 'staff_management:delete_target' target.id %}" method="POST" style="display:inline;">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this target?');" aria-label="Delete target {{ target.target_type.stname|default:'target' }}" title="Delete this target">
                                                    <i class="bi bi-trash me-1"></i>Delete
                                                </button>
                                            </form>
                                            <button type="button" class="btn btn-sm btn-info" data-bs-toggle="collapse" data-bs-target="#transactionHistory{{ target.id }}" aria-label="View transaction history for {{ target.target_type.stname|default:'target' }}" aria-expanded="false" title="View transaction history">
                                                <i class="bi bi-clock-history me-1"></i>History
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="8" class="p-0">
                                        <div id="transactionHistory{{ target.id }}" class="collapse">
                                            <table class="table table-sm table-bordered mb-0">
                                                <thead>
                                                    <tr>
                                                        <th>Date</th>
                                                        <th>Type</th>
                                                        <th>Value</th>
                                                        <th>Description</th>
                                                        <th>Modified</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for transaction in target.transactions.all %}
                                                        <tr class="{% if transaction.transaction_type == 'Withdrawal' %}table-danger{% else %}table-success{% endif %}">
                                                            <td>{{ transaction.transaction_date|date:"Y-m-d H:i"|default:"N/A" }}</td>
                                                            <td>{{ transaction.transaction_type|default:"N/A" }}</td>
                                                            <td>{{ transaction.actual_value|floatformat:2|default:"N/A" }}</td>
                                                            <td>{{ transaction.transdescription|default:"No description" }}</td>
                                                            <td>{{ transaction.modification_date|date:"Y-m-d H:i"|default:"N/A" }}</td>
                                                        </tr>
                                                    {% empty %}
                                                        <tr>
                                                            <td colspan="5" class="text-center">No transaction history.</td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </td>
                                </tr>
                                <!-- Modal for Recording Transaction -->
                                <div class="modal fade" id="updateModal{{ target.id }}" tabindex="-1" aria-labelledby="updateModalLabel{{ target.id }}" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="updateModalLabel{{ target.id }}">Record Transaction for: {{ target.target_type.stname|default:"Target" }}</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <form id="updateForm{{ target.id }}" method="POST" action="{% url 'staff_management:update_target' target.id %}">
                                                    {% csrf_token %}
                                                    <div class="mb-3">
                                                        <label for="transaction_type_{{ target.id }}" class="form-label">Transaction Type <span class="text-danger">*</span></label>
                                                        <select class="form-control" id="transaction_type_{{ target.id }}" name="transaction_type" required>
                                                            <option value="Deposit">Deposit</option>
                                                            <option value="Withdrawal">Withdrawal</option>
                                                        </select>
                                                        <div class="invalid-feedback">Please select a transaction type.</div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="actual_value_{{ target.id }}" class="form-label">Value (e.g., Number of Shares) <span class="text-danger">*</span></label>
                                                        <input type="number" step="0.01" class="form-control" id="actual_value_{{ target.id }}" name="actual_value" required>
                                                        <div class="invalid-feedback">Please enter a valid positive number.</div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="transaction_date_{{ target.id }}" class="form-label">Transaction Date <span class="text-danger">*</span></label>
                                                        <input type="text" class="form-control" id="transaction_date_{{ target.id }}" name="transaction_date" required>
                                                        <div class="invalid-feedback">Please select a valid date.</div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="transdescription_{{ target.id }}" class="form-label">Description (max 25 characters) <span class="text-danger">*</span></label>
                                                        <input type="text" class="form-control" id="transdescription_{{ target.id }}" name="transdescription" maxlength="25" required>
                                                        <div class="invalid-feedback">Description must be 1â€“25 characters.</div>
                                                    </div>
                                                    <div class="d-flex gap-2">
                                                        <button type="submit" class="btn btn-primary" aria-label="Record Transaction" onclick="return confirm('Are you sure you want to record this transaction?');">
                                                            <i class="bi bi-save me-1"></i>Record Transaction
                                                        </button>
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Cancel">Cancel</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Modal for Editing Target -->
                                <div class="modal fade" id="editGoalModal{{ target.id }}" tabindex="-1" aria-labelledby="editGoalModalLabel{{ target.id }}" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="editGoalModalLabel{{ target.id }}">Edit Target: {{ target.target_type.stname|default:"Target" }}</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <form id="editForm{{ target.id }}" method="POST" action="{% url 'staff_management:edit_target_goal' target.id %}">
                                                    {% csrf_token %}
                                                    <div class="mb-3">
                                                        <label for="target_type_{{ target.id }}" class="form-label">Target Type</label>
                                                        <input type="text" class="form-control" id="target_type_{{ target.id }}" value="{{ target.target_type.stname|default:'N/A' }}" readonly>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="period_{{ target.id }}" class="form-label">Period <span class="text-danger">*</span></label>
                                                        <select name="period" id="period_{{ target.id }}" class="form-control" required>
                                                            <option value="" disabled {% if not target.period %}selected{% endif %}>Select a period</option>
                                                            {% for value, label in target.PERIOD_CHOICES %}
                                                                <option value="{{ value }}" {% if target.period == value %}selected{% endif %}>{{ label }}</option>
                                                            {% endfor %}
                                                        </select>
                                                        <div class="invalid-feedback">Please select a period.</div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="goal_value_{{ target.id }}" class="form-label">Goal Value <span class="text-danger">*</span></label>
                                                        <input type="number" step="0.01" class="form-control" id="goal_value_{{ target.id }}" name="goal_value" value="{{ target.goal_value|floatformat:2 }}" required>
                                                        <div class="invalid-feedback">Please enter a valid positive number.</div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="start_date_{{ target.id }}" class="form-label">Start Date <span class="text-danger">*</span></label>
                                                        <input type="date" class="form-control" id="start_date_{{ target.id }}" name="start_date" value="{{ target.start_date|date:'Y-m-d'|default:'' }}" required>
                                                        <div class="invalid-feedback">Please select a valid start date.</div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="end_date_{{ target.id }}" class="form-label">End Date <span class="text-danger">*</span></label>
                                                        <input type="date" class="form-control" id="end_date_{{ target.id }}" name="end_date" value="{{ target.end_date|date:'Y-m-d'|default:'' }}" required>
                                                        <div class="invalid-feedback">Please select a valid end date.</div>
                                                    </div>
                                                    <div class="d-flex gap-2">
                                                        <button type="submit" class="btn btn-primary" aria-label="Save Target" onclick="return confirm('Are you sure you want to save these changes?');">
                                                            <i class="bi bi-save me-1"></i>Save Target
                                                        </button>
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Cancel">Cancel</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% empty %}
                                <tr><td colspan="8" class="text-center">No targets assigned yet.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% else %}
        <div class="alert alert-danger" role="alert">
            Staff member not found. Please check the staff ID or contact support.
        </div>
    {% endif %}
</div>

<style>
    .form-control:invalid, .form-control.is-invalid {
        border-color: var(--error-color, #dc3545);
    }
    .alert {
        position: relative;
        z-index: 1050;
    }
    .invalid-feedback {
        display: none;
        color: var(--error-color, #dc3545);
        font-size: 0.875rem;
    }
    .form-control.is-invalid ~ .invalid-feedback {
        display: block;
    }
    .text-active { color: green; }
    .text-ended { color: red; }
</style>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<script>
document.addEventListener('DOMContentLoaded', function () {
    window.flatpickrInstances = window.flatpickrInstances || {};

    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('shown.bs.modal', function () {
            const modalId = this.id;
            const match = modalId.match(/\d+$/);
            if (!match) return;

            const tid = match[0];
            const txnInput = document.getElementById(`transaction_date_${tid}`);
            const startInput = document.getElementById(`start_date_${tid}`);
            const endInput = document.getElementById(`end_date_${tid}`);

            try {
                if (txnInput && !window.flatpickrInstances[`transaction_${tid}`]) {
                    window.flatpickrInstances[`transaction_${tid}`] = flatpickr(txnInput, {
                        enableTime: true,
                        dateFormat: "Y-m-d H:i",
                        time_24hr: true,
                        minDate: startInput?.value || "today",
                        maxDate: endInput?.value,
                        defaultDate: txnInput.value || null,
                        onChange: function(selectedDates, dateStr) {
                            debounceValidate(tid, dateStr, 'transaction');
                        }
                    });
                }
                if (startInput && !window.flatpickrInstances[`start_${tid}`]) {
                    window.flatpickrInstances[`start_${tid}`] = flatpickr(startInput, {
                        dateFormat: "Y-m-d",
                        minDate: "today",
                        defaultDate: startInput.value || null,
                        onChange: function(selectedDates, dateStr) {
                            debounceValidate(tid, dateStr, 'start');
                            if (window.flatpickrInstances[`transaction_${tid}`]) {
                                window.flatpickrInstances[`transaction_${tid}`].set('minDate', dateStr);
                            }
                        }
                    });
                }
                if (endInput && !window.flatpickrInstances[`end_${tid}`]) {
                    window.flatpickrInstances[`end_${tid}`] = flatpickr(endInput, {
                        dateFormat: "Y-m-d",
                        minDate: startInput?.value || "today",
                        defaultDate: endInput.value || null,
                        onChange: function(selectedDates, dateStr) {
                            debounceValidate(tid, dateStr, 'end');
                            if (window.flatpickrInstances[`transaction_${tid}`]) {
                                window.flatpickrInstances[`transaction_${tid}`].set('maxDate', dateStr);
                            }
                        }
                    });
                }
            } catch (error) {
                console.error(`Flatpickr initialization error for target ${tid}:`, error);
            }
        });

        modal.addEventListener('hidden.bs.modal', function () {
            const modalId = this.id;
            const match = modalId.match(/\d+$/);
            if (!match) return;

            const tid = match[0];
            ['transaction', 'start', 'end'].forEach(type => {
                if (window.flatpickrInstances[`${type}_${tid}`]) {
                    window.flatpickrInstances[`${type}_${tid}`].destroy();
                    delete window.flatpickrInstances[`${type}_${tid}`];
                }
            });
        });
    });

    let debounceTimer;
    function debounceValidate(id, dateStr, type) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => validateDateRange(id), 300);
    }

    function validateDateRange(id) {
        const start = window.flatpickrInstances[`start_${id}`]?.selectedDates[0];
        const end = window.flatpickrInstances[`end_${id}`]?.selectedDates[0];
        const txn = window.flatpickrInstances[`transaction_${id}`]?.selectedDates[0];

        const startInput = document.getElementById(`start_date_${id}`);
        const endInput = document.getElementById(`end_date_${id}`);
        const txnInput = document.getElementById(`transaction_date_${id}`);

        let isValid = true;
        if (start && end && start > end) {
            alert("Start date must be before or equal to end date.");
            endInput.classList.add('is-invalid');
            isValid = false;
        } else {
            endInput?.classList.remove('is-invalid');
        }
        if (txn && start && txn < start) {
            alert("Transaction date must be on or after start date.");
            txnInput.classList.add('is-invalid');
            isValid = false;
        } else if (txn && end && txn > end) {
            alert("Transaction date must be on or before end date.");
            txnInput.classList.add('is-invalid');
            isValid = false;
        } else {
            txnInput?.classList.remove('is-invalid');
        }
        return isValid;
    }

    document.querySelectorAll('.alert').forEach(alert => {
        setTimeout(() => {
            try {
                bootstrap.Alert.getOrCreateInstance(alert).close();
            } catch (error) {
                console.warn('Alert dismissal error:', error);
            }
        }, 5000);
    });

    document.querySelectorAll('form[id^="updateForm"], form[id^="editForm"]').forEach(form => {
        form.addEventListener('submit', function (e) {
            if (!validateForm(this)) {
                e.preventDefault();
            }
        });

        form.querySelectorAll('input, select').forEach(input => {
            input.addEventListener('input', () => validateForm(form));
            input.addEventListener('change', () => validateForm(form));
        });
    });

    function validateForm(form) {
        const match = form.id.match(/(edit|update)Form(\d+)/);
        if (!match) return true;

        const type = match[1];
        const id = match[2];
        let isValid = true;

        if (type === 'update') {
            const value = form.querySelector(`#actual_value_${id}`);
            const desc = form.querySelector(`#transdescription_${id}`);
            const txnType = form.querySelector(`#transaction_type_${id}`);
            const txnDate = form.querySelector(`#transaction_date_${id}`);

            if (!txnType.value) {
                txnType.classList.add('is-invalid');
                isValid = false;
            } else {
                txnType.classList.remove('is-invalid');
            }

            const v = parseFloat(value?.value || '');
            if (isNaN(v) || v <= 0) {
                value.classList.add('is-invalid');
                isValid = false;
            } else {
                value.classList.remove('is-invalid');
            }

            if (!desc?.value.trim() || desc.value.length > 25) {
                desc.classList.add('is-invalid');
                isValid = false;
            } else {
                desc.classList.remove('is-invalid');
            }

            if (!txnDate.value) {
                txnDate.classList.add('is-invalid');
                isValid = false;
            } else {
                txnDate.classList.remove('is-invalid');
            }
        } else if (type === 'edit') {
            const start = form.querySelector(`#start_date_${id}`);
            const end = form.querySelector(`#end_date_${id}`);
            const goal = form.querySelector(`#goal_value_${id}`);
            const period = form.querySelector(`#period_${id}`);

            if (!period.value) {
                period.classList.add('is-invalid');
                isValid = false;
            } else {
                period.classList.remove('is-invalid');
            }

            const gValue = parseFloat(goal?.value);
            if (isNaN(gValue) || gValue <= 0) {
                goal.classList.add('is-invalid');
                isValid = false;
            } else {
                goal.classList.remove('is-invalid');
            }

            if (!start?.value) {
                start.classList.add('is-invalid');
                isValid = false;
            } else {
                start.classList.remove('is-invalid');
            }

            if (!end?.value) {
                end.classList.add('is-invalid');
                isValid = false;
            } else {
                end.classList.remove('is-invalid');
            }

            if (start?.value && end?.value) {
                const sDate = new Date(start.value);
                const eDate = new Date(end.value);
                if (sDate > eDate) {
                    end.classList.add('is-invalid');
                    isValid = false;
                } else {
                    end.classList.remove('is-invalid');
                }
            }
        }
        return isValid;
    }

    document.querySelectorAll('[data-bs-target^="#transactionHistory"]').forEach(btn => {
        btn.addEventListener('click', function () {
            const targetId = this.getAttribute('data-bs-target');
            const collapse = document.querySelector(targetId);
            if (!collapse) return;

            const isOpen = collapse.classList.contains('show');
            this.setAttribute('aria-expanded', !isOpen);
            this.innerHTML = `<i class="bi bi-clock-history${isOpen ? '' : '-fill'} me-1"></i>History`;
        });
    });
});
</script>
{% endblock %}